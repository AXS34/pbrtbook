\section{逼真渲染和光线追踪算法}\label{sec:逼真渲染和光线追踪算法}

逼真渲染的目标是创建3D场景的图像且与同一场景的照片难以区分。
在我们介绍渲染流程之前要重点理解的是，
此处的{\itshape 难以区分}一词不是精确说法，
因为它涉及人类观察者，
不同观察者对同一图像的感知可能是不同的。
尽管本书会涉及少量感知问题，
但明确给出观察者的精确特性是非常困难且远未解决的问题。
绝大多数时候，我们都对针对光及其与物质相互作用的物理仿真感到满意，
并以我们对显示技术的理解尽可能向观察者展示最好的图像。

几乎所有逼真渲染系统都基于光线追踪算法。
光线追踪算法其实很简单；
它跟随光线\sidenote{译者注：原文a ray of light。
      此外会按个人理解把ray译作“光线”或“射线”，把light译作“光”或“光线”。}路径
穿过场景与环境中的物体相互作用并反射。
虽然编写光线追踪器的方法有很多，
但所有这些系统都必须模拟至少一项以下对象和现象：
\begin{itemize}
      \item \keyindex{相机}{cameras}{camera相机}： 相机模型决定了从哪里、怎样观察场景，
            包括场景的图像是怎样记录到传感器上的。
            许多渲染系统从相机处开始生成视线并追踪到场景中。
      \item \keyindex{光线-物体交点}{ray–object intersections}{ray光线}： 此外，我们需要确定
            交点处物体的特定属性，例如曲面法线或材质。
            多数光线追踪器都有测试光线与多个物体相交的功能，
            典型的例如沿光线返回最近交点。
      \item \keyindex{光源}{light sources}{light光}： 没有光，渲染场景就没有意义。
            光线追踪器必须对整个场景的光分布建模，
            不仅包括灯光自身的位置，还包括它们向整个场景发散能量的方式。
      \item \keyindex{可见性}{visibility}{}：为了知道给定光是否在表面上一点积累能量，
            必须确认从该点到光源是否存在一条不中断的路径。
            幸运的是，在光线追踪器中这个问题很容易回答，
            因为我们可以构造从表面到光源\sidenote{译者注：原文为light，我按个人理解译作“光源”。}的射线，
            寻找最近的光线-物体交点，
            并比较交点距离和光源距离。
      \item \keyindex{表面散射}{surface scattering}{}：每个物体都必须提供外观描述，
            包括光如何与物体表面相互作用等信息，
            以及再辐射\sidenote{译者注：原文reradiated。}（或散射\sidenote{译者注：原文scattered。}）光的性质。
            表面散射模型是典型的参数化模型，
            因此可以模拟各种外观。
      \item \keyindex{间接光传输}{indirect light transport}{light光}\sidenote{译者注：这里把transport译作“传输”是为了
                  与下一段propagation译作“传播”区分开，但个人理解似乎就是“传播”的意思。}：因为
            光在一个物体上反射或折射后可能遇到另一个物体，
            所以通常有必要追踪从表面发出的额外光线来捕捉这种效应。
      \item \keyindex{光线传播}{ray propagation}{ray光线}：我们需要知道光在空间中沿光线传播时发生了什么。
            如果渲染真空中的场景，则光能量沿光线保持恒定。
            真正的真空虽然在地球上是罕见的，
            但对许多环境而言是合理的近似。
            更多复杂模型可用于追踪穿过雾、烟、大气等的光线。
\end{itemize}

本节将简要讨论以上每个仿真任务。
后续章节会展示pbrt底层仿真组件的高级接口，
了解贯穿主渲染循环的单个光线处理过程。
我们还会介绍基于Turner Whitted的
原始光线追踪算法的表面散射模型实现。

\subsection{相机}\label{sub:相机}

几乎每个人都用过\keyindex{相机}{camera}{}，熟悉它的基本功能：
你想用一张图像记下世界（通常是按按钮或点击屏幕），
然后图像就被记录到\keyindex{胶片}{film}{}或电子传感器上。
\keyindex{针孔相机}{pinhole camera}{camera相机}是最简单的拍照设备之一。
它由一端打有小孔的遮光盒组成（\reffig{1.1}）。
当针孔未被遮挡时，光射进针孔落到固定在盒子另一端的相纸上。
虽然它很简单，但这种相机至今仍在使用，常用于艺术目的。
要在胶片上获得足够的光以形成图像需要非常长的曝光时间。
\begin{figure}[h]
      \centering\input{Pictures/chap01/PinholeCamera.tex}
      \caption{针孔相机}\label{fig:1.1}
\end{figure}

虽然大多数相机都比针孔相机复杂得多，
但针孔相机是仿真的便捷起点。
相机最重要的功能是定义会被记录到胶片上的场景部分。
在\reffig{1.1}中，我们可以看见从针孔到胶片边的连线
是如何构造出延伸到场景中的双锥体的。
不在该锥体内的物体不会在胶片上成像。
因为实际的相机成像形状比锥体更复杂，
所以我们把这个可能在胶片上成像的空间区域称为\keyindex{视见体}{viewing volume}{}。

针孔相机也可以看作是把胶片平面放置在针孔的\emph{前方}但距离不变（\reffig{1.2}）。
注意从针孔到胶片的连线正好定义了和之前一样的视见体。
当然，这不是真实相机的实际构建方法，
但对于仿真目的而言它是个方便的抽象。
当胶片（或成像）平面在针孔前时，
针孔也常常改称作\keyindex{眼睛}{eye}{}。
\begin{figure}[h]
      \centering\input{Pictures/chap01/Filminfront.tex}
      \caption{当仿真针孔相机时，胶片放在针孔前的平面，针孔改称为\emph{眼睛}。}\label{fig:1.2}
\end{figure}

现在我们说到渲染的关键问题：
相机在图像中的每一点记录下的颜色值是什么？
回想最初的针孔相机，
显然光线只有沿着连接针孔与胶片上一点的向量
传播才能作用于胶片上的相应位置。
在把胶片放在眼睛前的仿真相机中，
我们关注沿着图像点传播到眼睛的光量。

因此，相机仿真器的重要任务是取图像上一点
并生成\keyindex{射线}{ray}{}，
沿这些射线的\keyindex{入射光}{incident light}{light光}可作用于该图像位置。
因为射线由一个\keyindex{端点}{origin point}{point点}和
一个\keyindex{方向向量}{direction vector}{vector向量}组成，
所以该任务对\reffig{1.2}的针孔相机而言很简单：
它把针孔作为端点，
把从针孔到像平面\sidenote{译者注：原文near plane，按
      个人理解改译为“像平面”。}的向量
作为射线的方向。
对于含有多个透镜的复杂相机模型，
则图像上给定点相应的射线需要更多计算
（\refsec{逼真相机}介绍了这类模型的实现）。


\subsection{光线-物体交点}\label{sub:光线-物体交点}

相机每次生成射线时，
渲染器第一个任务就是确定
如果有的话，哪个物体和该射线最先\keyindex{相交}{intersect}{}，
交点在哪里。
该\keyindex{交点}{intersection point}{point点}是沿射线可见的，
我们想要模拟光在该点与物体的相互作用。
为了找到交点，我们必须把场景中的所有物体拿来和该射线测试，
并选出与该射线首先相交的那个。
给定一射线$\mathrm{r}$，首先将其写成\keyindex{参数形式}{parametric form}{}：
\begin{align*}
      \mathrm{r}(t)=\mathrm{o}+t\mathbf{d},
\end{align*}
其中$\mathrm{o}$是射线端点，$\mathbf{d}$是其方向向量，$t$是定义在$(0,\infty)$的\keyindex{参数}{parameter}{}。
我们可以通过指定参数$t$的值并代入上式求得射线上的一点。

通常很容易寻找射线$\mathrm{r}$和由隐函数$F(x,y,z)=0$定义的\keyindex{曲面}{surface}{}的交点。
首先把射线方程代入\keyindex{隐式方程}{implicit equation}{equation方程}，
得到只含有参数$t$的新方程。
然后从中解出$t$并把最小正根代入射线方程得到所需的点。
例如，以\keyindex{原点}{origin}{point点}为球心，$r$为\keyindex{半径}{radius}{}的\keyindex{球}{sphere}{}的隐式方程是
\begin{align*}
      x^2+y^2+z^2-r^2=0.
\end{align*}
代入射线方程，得到
\begin{align*}
      (\mathrm{o}_x+t\mathbf{d}_x)^2+(\mathrm{o}_y+t\mathbf{d}_y)^2+(\mathrm{o}_z+t\mathbf{d}_z)^2-r^2=0.
\end{align*}
上式除了$t$外的所有值都是已知的，因此是易解的关于$t$的二次方程。
如果没有正根，则射线与球面错开了；
如果有，则最小正根给出了交点。

对于光线追踪器的其余部分。只有交点信息是不够的；
它还需要知道该点表明的特定属性。
首先，必须确定该点的材质表示
并传给光线追踪算法之后的步骤。
其次，还需要交点处额外的几何信息来对该点\keyindex{着色}{shade}{}。
例如，曲面\keyindex{法线}{normal}{}$\mathbf{n}$是必需的。
虽然许多光线追踪器只对$\mathbf{n}$操作，
但像pbrt这类更复杂的渲染系统还需要更多信息，
比如位置的各个\keyindex{偏导数}{partial derivative}{derivative导数}以及
关于曲面局部参数化的曲面法线。

当然，绝大多数场景含有多个物体。
暴力法指依次用每个物体对射线测试，
从所有交点中选出$t$的最小正值来求得最近交点。
该方法虽然正确但对哪怕适度复杂的场景也很慢。
更好的方法是在射线交点处理中
并入一个\keyindex{加速结构}{acceleration structure}{}快速否决整组物体。
快速剔除无关几何体的能力意味着光线追踪常能以$O(I\log{N})$的时间运行，
其中$I$是图像像素数目，
$N$是场景中物体的数量
（然而构建加速结构本身至少需要$O(N)$时间）。
\begin{remark}
      虽然光线追踪的对数复杂度是
      常被认为是其主要优点，但该复杂度只在平均意义下是典型正确的。
      在计算几何文献中发表的许多光线追踪算法都保证有对数运行时间，
      但它们只在特定种类场景下才能工作，并且预处理开销和存储要求很高。
      Szirmay-Kalos和Márton提供了相关参考文献\citep{10.1007/BF02684409}
      {\itshape （译者注：原文缺失该引文标注，本人推测为该文）}。
      但好在表现真实环境的场景通常不会遇到这种最坏的情形。
      实践中本书介绍的射线相交算法是次线性的，
      但在去掉大量预处理和存储开销时
      总是有可能构造出使光线追踪以$O(IN)$时间运行的最坏情形。
\end{remark}

pbrt为各种形状实现的几何接口将在第\refchap{形状}介绍，
加速接口和实现在第\refchap{图元和交点加速}说明。

\subsection{光分布}\label{sub:光分布}

光线-物体交点阶段给出了要着色的点和该点的局部几何信息。
回想我们的最终目标是找出从该点出发朝相机方向传播的光量。
为此需要知道有多少光\emph{到达}了该点。
这同时涉及到场景中光的\emph{几何}和\emph{辐射}分布。
对于非常简单的光源（例如\keyindex{点光源}{point light}{light光}），
光的\keyindex{几何分布}{geometric distribution}{distribution分布}只需
知道光源位置即可。
然而真实世界并不存在点光源，
所以基于物理的光照常基于\keyindex{面光源}{area light sources}{light光}。
这意味着光源和表面发光的几何体关联。
但本节我们用点光源说明光分布的构成；
光度量和分布的严格讨论是第\refchap{颜色和辐射学}和第\refchap{光源}的主题。

我们常常想知道光在交点附近的微分面积上积累的功率（\reffig{1.3}）。
假设点光源具有功率$\varPhi$并向所有方向均匀辐射光
\sidenote{译者注：原文使用正体字母$\Phi$，
      我把标量统一改为了斜体；
      此外原文正确使用了$\pi$的正体表示圆周率，
      但我因为字体环境冲突无法打出正体，
      所以全书被迫用的斜体。}。
这意味着围绕光源的单位球面在单位面积上的光量
为$\displaystyle\frac{\varPhi}{4\mathrm{\pi}}$
（这些度量将在\refsec{辐射学}解释和形式化）。
\begin{figure}[h]
      \centering\input{Pictures/chap01/Basicreflectionsetting.tex}
      \caption{确定由点光源到达一点的单位面积功率的几何结构。
            该点到光源的距离记作$r$。}\label{fig:1.3}
\end{figure}

如果考虑两个这样的球面（\reffig{1.4}），
很明显大球上一点的单位面积功率必然比小球低，
因为相同的总功率分布在了更大的面积上。
特别地，到达半径为$r$的球面上一点的单位面积功率正比于$\displaystyle\frac{1}{r^2}$。
\begin{figure}
      \centering\input{Pictures/chap01/Lightspheresequalpower.tex}
      \caption{因为点光源向所有方向均匀辐射光，
            所以以光源为球心的任意球面所积累的总功率相同。}
      \label{fig:1.4}
\end{figure}

此外可以看出，如果一小块曲面$\mathrm{d}A$相对于
从曲面指向光源的向量倾斜了角度$\theta$，
则$\mathrm{d}A$上积累的功率正比于$\cos{\theta}$。
综上所述，单位面积上的微分功率
（\keyindex{微分辐照度}{differential irradiance}{irradiance辐照度}）
$\mathrm{d}E$为
\begin{align*}
      \mathrm{d}E=\frac{\varPhi\cos{\theta}}{4\mathrm{\pi}r^2}.
\end{align*}

熟悉计算机图形学中基本光照的读者会注意到
该方程包含了两个熟悉的定律：
上述面的光照随倾斜按余弦衰减，
随距离按$\displaystyle\frac{1}{r^2}$衰减。